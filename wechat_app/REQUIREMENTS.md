# 微信小程序访视计划工具 - 需求文档

## 1. 背景与目标
本工具面向临床试验的项目经理与 CRA，用于根据实验方案的访视规则快速生成访视计划，并标注节假日影响，辅助选择合适的访视安排。目标是以低学习成本完成计划生成、查看与导出。

### 目标
- 提供“实验方案 + 首访日期”即可生成访视计划的轻量体验。
- 明确节假日/周末影响，并统计无法避开的访视窗口。
- 支持历史记录留存与导出，方便协作。

### 非目标（一期不做）
- 自动推荐“最佳首访日期”。
- 图片导出与在线协同。
- 多项目/多中心/多受试者的复杂管理界面。

## 2. 目标用户
- 临床试验项目经理
- CRA

## 3. 核心概念
- 实验方案：包含访视次数、频率、窗口等规则。
- 访视计划：在方案规则 + 首访日期下生成的计划结果。
- 节假日规则：法定节假日 + 手动覆盖（项目假期/调休）。

## 4. 页面与功能范围（一期）
### 4.1 实验方案管理
- 新建/编辑/删除实验方案。
- 方案字段：
  - 方案名称
  - 总访视次数
  - 访视频率（固定值或按次列表）
  - 访视窗口（固定值或按次列表）
  - 访视命名规则（可选，如 D3、F4）

### 4.2 访视计划生成
- 选择方案 + 录入首次访视日期。
- 生成访视计划表：
  - 每次访视的基准日期
  - 窗口起止日期
  - 节假日/周末标记
- 可调整首访日期并重新生成。
- 统计“无法避开节假日”的访视次数与详情。

### 4.3 访视计划结果与导出
- 展示计划表（按访视次数排序）。
- 导出为 Excel 文件，若失败可切换 CSV 作为兜底。
- 保存为历史记录（生成快照）。

### 4.4 节假日管理
- 内置法定节假日数据。
- 允许用户新增或覆盖指定日期为“节假日/工作日”。
- 标注节假日来源（法定/自定义）。

### 4.5 历史记录
- 列表查看历史记录（按方案/首访日期/创建时间筛选）。
- 查看单条详情。
- 支持从历史记录导出 Excel。

## 5. 计算规则
### 5.1 访视频率
- 固定频率：如“28”，表示每次间隔 28 天。
- 可变频率：如“28,28,56”，按次递推。
- 频率数量必须等于总访视次数 - 1。

### 5.2 访视窗口
- 固定窗口：如“7”，表示基准日期前后 7 天。
- 可变窗口：如“7,7,14”，按次递推。
- 窗口数量必须等于总访视次数 - 1。
- 首次访视窗口默认 0。

### 5.3 节假日判定
日期类型包含：
- 法定节假日
- 周末（周六/周日）
- 自定义节假日/调休

### 5.4 无法避开节假日
若某次访视窗口内所有日期均为节假日或周末，则计入“无法避开节假日”统计，并记录详情。

## 6. 导出要求
- 导出为 Excel（优先），CSV 作为兜底方案。
- 导出字段最少包含：
  - 方案名称
  - 首访日期
  - 访视序号
  - 访视名称
  - 日期类型（基准/提前/延后）
  - 计划日期
  - 节假日信息

## 7. 体验与交互要求
- 全流程不超过 2 次点击即可生成计划（选择方案 + 选择首访日期）。
- 移动端输入尽量使用选择器和默认值。
- 错误提示需明确（如频率数量不匹配）。

## 8. 数据与隐私
- 所有数据仅保存在用户本地（小程序本地存储）。
- 不引入真实受试者数据。

## 9. 待确认事项
- Excel 导出格式：使用 `.xlsx`，同时提供 CSV 兜底。
- 是否需要多语言（默认简体中文）。
