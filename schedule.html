<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日访视安排</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin-top: 30px;
        }
        /* 添加访视组的背景色样式 */
        .visit-group-even {
            background-color: #e3f2fd !important; /* 浅蓝色 */
        }
        
        .visit-group-odd {
            background-color: #fff3e0 !important; /* 浅橙色 */
        }
        
        /* 修改鼠标悬停效果 */
        .visit-group-even:hover {
            background-color: #bbdefb !important; /* 深一点的蓝色 */
        }
        
        .visit-group-odd:hover {
            background-color: #ffe0b2 !important; /* 深一点的橙色 */
        }
        
        /* 移除 Bootstrap 的默认条纹样式 */
        .table-visits > tbody > tr:nth-of-type(odd) {
            background-color: inherit;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center">今日访视安排</h1>
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-8 mb-3 mb-md-0">
                        <label for="dateRange" class="form-label">选择日期范围:</label>
                        <input type="text" class="form-control" id="dateRange">
                    </div>
                    <div class="col-md-4">
                        <button id="refreshButton" class="btn btn-primary w-100">刷新访视安排</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <table id="scheduleTable" class="table table-visits table-hover">
                    <thead>
                        <tr>
                            <th>受试者名称</th>
                            <th>访视次数</th>
                            <th>访视日期</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 数据将通过 JavaScript 动态插入这里 -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="text-center mt-4">
            <a href="index.html" class="btn btn-primary">返回添加受试者信息</a>
            <a href="view.html" class="btn btn-secondary">查看已保存的受试者信息</a>
            <a href="landing.html" class="btn btn-info">返回首页</a>
        </div>
    </div>

    <!-- 引入 Bootstrap JS 和 Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
    <!-- 引入 Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- 引入 Flatpickr 中文语言包 -->
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh.js"></script>
    <script>
        let db;
        const dbName = "SubjectsDB";

        // 初始化 Flatpickr 为日期范围选择器
        const datePicker = flatpickr("#dateRange", {
            mode: "range",
            dateFormat: "Y-m-d",
            locale: "zh",
            defaultDate: [new Date(), new Date()],
            altInput: true,
            altFormat: "Y年m月d日",
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length === 2) {
                    loadSchedule(selectedDates[0], selectedDates[1]);
                }
            }
        });

        const request = indexedDB.open(dbName);

        request.onerror = function(event) {
            console.error("数据库错误: " + event.target.error);
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            console.log("数据库打开成功");
            loadSchedule(new Date().toISOString().split('T')[0]);
        };

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            const objectStore = db.createObjectStore("subjects", { keyPath: "id", autoIncrement: true });
            objectStore.createIndex("name", "name", { unique: false });
            objectStore.createIndex("firstDate", "firstDate", { unique: false });
        };

        function loadSchedule(startDate, endDate) {
            const tableBody = document.querySelector('#scheduleTable tbody');
            tableBody.innerHTML = '';

            const objectStore = db.transaction("subjects").objectStore("subjects");

            objectStore.getAll().onsuccess = function(event) {
                const subjects = event.target.result;
                let scheduleItems = [];

                subjects.forEach(subject => {
                    const firstDate = new Date(subject.firstDate);
                    const totalVisits = parseInt(subject.totalVisits);
                    
                    // 解析访视间隔
                    let frequencies = [];
                    if (subject.frequency.includes(',')) {
                        frequencies = subject.frequency.split(',').map(Number);
                        if (frequencies.length !== totalVisits - 1) {
                            console.error('访视间隔数量不正确');
                            return;
                        }
                    } else {
                        // 如果是单个数字，创建相同间隔的数组
                        const fixedFrequency = parseInt(subject.frequency);
                        frequencies = Array(totalVisits - 1).fill(fixedFrequency);
                    }
                    
                    // 解析访视窗口
                    let visitWindows = [];
                    if (subject.visitWindow && subject.visitWindow.trim() !== '') {
                        const windowValue = subject.visitWindow.trim();
                        
                        if (windowValue.includes(',')) {
                            // 如果是逗号分隔的格式
                            visitWindows = windowValue.split(',').map(Number);
                            if (visitWindows.length !== totalVisits - 1) {
                                console.error('访视窗口数量不正确');
                                return;
                            }
                            // 验证所有窗口值是否为非负数
                            if (visitWindows.some(w => isNaN(w) || w < 0)) {
                                console.error('存在无效的访视窗口值');
                                return;
                            }
                        } else {
                            // 如果是单个数字，表示固定窗口大小
                            const fixedWindow = parseInt(windowValue);
                            if (isNaN(fixedWindow) || fixedWindow < 0) {
                                console.error('无效的固定访视窗口值');
                                return;
                            }
                            // 创建相同窗口大小的数组
                            visitWindows = Array(totalVisits - 1).fill(fixedWindow);
                        }
                    } else {
                        // 如果未设置访视窗口，则所有访视的窗口期都是0
                        visitWindows = Array(totalVisits - 1).fill(0);
                    }

                    // 计算每次访视的基准日期
                    let visitDates = [firstDate];  // 存储每次访视的基准日期
                    let currentDate = new Date(firstDate);
                    
                    // 计算后续访视的基准日期
                    for (let i = 0; i < frequencies.length; i++) {
                        currentDate = new Date(currentDate.getTime() + frequencies[i] * 24 * 60 * 60 * 1000);
                        visitDates.push(currentDate);
                    }

                    // 遍历每次访视生成计划
                    visitDates.forEach((baseDate, visitNum) => {
                        // 首次访视或无窗口期时只显示基准日期
                        if (visitNum === 0 || (visitNum > 0 && visitWindows[visitNum - 1] === 0)) {
                            if (baseDate >= startDate && baseDate <= endDate) {
                                scheduleItems.push({
                                    name: subject.name,
                                    visitNumber: visitNum + 1,
                                    visitDate: baseDate,
                                    dateType: '基准日期'
                                });
                            }
                            return;
                        }

                        // 非首次访视且有窗口期时，显示窗口期内的所有日期
                        const window = visitWindows[visitNum - 1];
                        for (let offset = -window; offset <= window; offset++) {
                            const visitDate = new Date(baseDate.getTime() + offset * 24 * 60 * 60 * 1000);
                            
                            if (visitDate >= startDate && visitDate <= endDate) {
                                let dateType = '基准日期';
                                if (offset < 0) {
                                    dateType = `提前${Math.abs(offset)}天`;
                                } else if (offset > 0) {
                                    dateType = `延后${offset}天`;
                                }
                                
                                scheduleItems.push({
                                    name: subject.name,
                                    visitNumber: visitNum + 1,
                                    visitDate: visitDate,
                                    dateType: dateType
                                });
                            }
                        }
                    });
                });

                // 按日期排序
                scheduleItems.sort((a, b) => {
                    // 首先按日期排序
                    const dateCompare = a.visitDate - b.visitDate;
                    if (dateCompare !== 0) return dateCompare;
                    
                    // 日期相同时，按受试者名称排序
                    if (a.name !== b.name) return a.name.localeCompare(b.name);
                    
                    // 最后按访视次数排序
                    return a.visitNumber - b.visitNumber;
                });

                // 用于跟踪上一个访视组
                let lastVisitGroup = null;
                let isEvenGroup = true;

                // 显示排序后的访视安排
                scheduleItems.forEach(item => {
                    const row = tableBody.insertRow();
                    
                    // 确定当前访视组（受试者名称+访视次数的组合）
                    const currentVisitGroup = `${item.name}-${item.visitNumber}`;
                    
                    // 如果是新的访视组，切换奇偶标记
                    if (currentVisitGroup !== lastVisitGroup) {
                        isEvenGroup = !isEvenGroup;
                        lastVisitGroup = currentVisitGroup;
                    }
                    
                    // 添加对应的背景色类
                    row.className = isEvenGroup ? 'visit-group-even' : 'visit-group-odd';
                    
                    // 填充单元格内容
                    row.insertCell(0).textContent = item.name;
                    row.insertCell(1).textContent = `第 ${item.visitNumber} 次访视`;
                    const dateCell = row.insertCell(2);
                    dateCell.textContent = `${formatDate(item.visitDate)} (${item.dateType})`;
                    if (item.dateType !== '基准日期') {
                        dateCell.style.color = 'blue';
                    }
                });

                if (scheduleItems.length === 0) {
                    const row = tableBody.insertRow();
                    const cell = row.insertCell(0);
                    cell.colSpan = 3;
                    cell.textContent = "所选日期范围内无访视安排";
                    cell.classList.add("text-center");
                }
            };
        }

        function formatDate(date) {
            return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
        }

        // 修改刷新按钮事件监听
        document.getElementById('refreshButton').addEventListener('click', function() {
            const dates = datePicker.selectedDates;
            if (dates.length === 2) {
                loadSchedule(dates[0], dates[1]);
            } else {
                alert('请选择完整的日期范围');
            }
        });

        // 页面加载时初始化今天的数据
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            loadSchedule(today, today);
        });
    </script>
</body>
</html>
