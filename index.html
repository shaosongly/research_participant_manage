<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>受试者信息提交</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 600px;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center">受试者信息提交</h1>
        <div class="card">
            <div class="card-body">
                <form id="subjectForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">受试者名称:</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="firstDate" class="form-label">首次受试日期:</label>
                        <input type="text" class="form-control" id="firstDate" name="firstDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="frequency" class="form-label">访视频率:</label>
                        <input type="text" class="form-control" id="frequency" name="frequency" required>
                    </div>
                    <div class="mb-3">
                        <label for="totalVisits" class="form-label">总访视次数:</label>
                        <input type="number" class="form-control" id="totalVisits" name="totalVisits" required>
                    </div>
                    <div class="mb-3">
                        <label for="visitWindow" class="form-label">访视窗口(天):</label>
                        <input type="text" class="form-control" id="visitWindow" name="visitWindow" 
                               placeholder="用逗号分隔每次访视的窗口天数，如: 1,2,3,4">
                        <div class="form-text">不填写则表示无访视窗口限制。每个数字代表对应次序访视的窗口天数。</div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">提交</button>
                </form>
            </div>
        </div>
        <div class="text-center mt-4">
            <a href="view.html" class="btn btn-secondary">查看已保存的受试者信息</a>
            <a href="schedule.html" class="btn btn-secondary">查看今日访视安排</a>
            <a href="landing.html" class="btn btn-info">返回首页</a>
        </div>
        <h2 class="mt-5 mb-4 text-center">批量导入受试者信息</h2>
        <div class="card">
            <div class="card-body">
                <form id="batchImportForm">
                    <div class="mb-3">
                        <label for="excelFile" class="form-label">选择Excel文件：</label>
                        <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls" required>
                    </div>
                    <div id="columnMapping" class="mb-3">
                        <!-- 字段映射将在这里动态生成 -->
                    </div>
                    <button type="submit" class="btn btn-primary w-100">批量导入</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 引入 Bootstrap JS 和 Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
    <!-- 引入 Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- 引入 Flatpickr 中文语言包 -->
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh.js"></script>
    <!-- 引入自定义 JS -->
    <script src="index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script>
        // 初始化 Flatpickr
        flatpickr("#firstDate", {
            dateFormat: "Y-m-d",
            locale: "zh",
            allowInput: true,
            altInput: true,
            altFormat: "Y年m月d日",
            disableMobile: true
        });

        // 添加表单提交事件监听器
        document.getElementById('subjectForm').addEventListener('submit', function(e) {
            e.preventDefault(); // 阻止表单默认提交行为

            // 获取表单数据
            const formData = new FormData(this);
            const visitWindow = formData.get('visitWindow').trim();
            
            // 验证访视窗口格式
            if (visitWindow !== '' && !/^\d+(?:,\d+)*$/.test(visitWindow)) {
                alert('访视窗口格式不正确，请使用逗号分隔的数字，如: 1,2,3,4');
                return;
            }

            const subjectData = {
                name: formData.get('name'),
                firstDate: formData.get('firstDate'),
                frequency: formData.get('frequency'),
                totalVisits: formData.get('totalVisits'),
                visitWindow: visitWindow // 如果为空字符串则表示无窗口限制
            };

            const dbRequest = indexedDB.open("SubjectsDB");

            dbRequest.onerror = function(event) {
                console.error("数据库错误: " + event.target.error);
            };

            dbRequest.onsuccess = function(event) {
                const db = event.target.result;
                try {
                    const transaction = db.transaction(["subjects"], "readwrite");
                    const objectStore = transaction.objectStore("subjects");
                    const addRequest = objectStore.add(subjectData);

                    addRequest.onsuccess = function() {
                        console.log("数据保存成功");
                        window.location.href = 'view.html';
                    };

                    addRequest.onerror = function(event) {
                        console.error("保存数据时出错:", event.target.error);
                    };
                } catch (error) {
                    console.error("执行事务时出错:", error);
                }
            };
        });

        // 处理Excel文件上传
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const headers = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0];

                // 生成字段映射选择
                const mappingHtml = headers.map((header, index) => `
                    <div class="mb-2">
                        <label class="form-label">Excel列 "${header}" 对应：</label>
                        <select class="form-select" data-excel-column="${index}">
                            <option value="">请选择</option>
                            <option value="name">受试者名称</option>
                            <option value="firstDate">首次受试日期</option>
                            <option value="frequency">访视频率</option>
                            <option value="totalVisits">总访视次数</option>
                            <option value="visitWindow">访视窗口</option>
                        </select>
                    </div>
                `).join('');

                document.getElementById('columnMapping').innerHTML = mappingHtml;
            };

            reader.readAsArrayBuffer(file);
        });

        // 处理批量导入
        document.getElementById('batchImportForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const file = document.getElementById('excelFile').files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, raw: false});

                // 获取用户定义的字段映射
                const mapping = {};
                document.querySelectorAll('#columnMapping select').forEach(select => {
                    const field = select.value;
                    const columnIndex = parseInt(select.dataset.excelColumn);
                    mapping[field] = columnIndex;
                });

                // 转换数据
                const headers = jsonData[0];
                const subjectsData = jsonData.slice(1).map(row => {
                    const subject = {};
                    Object.keys(mapping).forEach(field => {
                        const columnIndex = mapping[field];
                        if (columnIndex !== undefined && columnIndex < row.length) {
                            if (field === 'firstDate') {
                                // 处理日期
                                const dateValue = row[columnIndex];
                                const parsedDate = parseExcelDate(dateValue);
                                subject[field] = parsedDate ? parsedDate.toISOString().split('T')[0] : null;
                            } else if (field === 'visitWindow') {
                                // 处理访视窗口数据
                                const windowValue = row[columnIndex];
                                // 如果Excel中的值为空，则设置为空字符串
                                subject[field] = windowValue ? String(windowValue).trim() : '';
                            } else {
                                subject[field] = row[columnIndex];
                            }
                        }
                    });
                    return subject;
                });

                console.log("解析后的数据:", subjectsData);

                // 批量导入数据
                const request = indexedDB.open("SubjectsDB");

                request.onsuccess = function(event) {
                    const db = event.target.result;
                    const transaction = db.transaction(["subjects"], "readwrite");
                    const objectStore = transaction.objectStore("subjects");

                    let successCount = 0;
                    subjectsData.forEach(subject => {
                        const addRequest = objectStore.add(subject);
                        addRequest.onsuccess = function() {
                            successCount++;
                            if (successCount === subjectsData.length) {
                                alert(`成功导入 ${successCount} 条记录`);
                                window.location.href = 'view.html';
                            }
                        };
                        addRequest.onerror = function(event) {
                            console.error("添加记录时出错:", event.target.error);
                        };
                    });
                };

                request.onerror = function(event) {
                    console.error("数据库错误: " + event.target.error);
                };
            };

            reader.readAsArrayBuffer(file);
        });

        // 修改后的日期解析函数
        function parseExcelDate(dateValue) {
            console.log("Original date value:", dateValue);
            
            if (dateValue instanceof Date) {
                return new Date(Date.UTC(dateValue.getFullYear(), dateValue.getMonth(), dateValue.getDate()));
            }
            
            if (typeof dateValue === 'number') {
                // Excel的日期数字是从1900年1月1日开始的天数
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                return new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            }
            
            if (typeof dateValue === 'string') {
                // 处理 "MMDD" 格式
                if (/^\d{4}$/.test(dateValue)) {
                    const month = parseInt(dateValue.substr(0, 2)) - 1; // JavaScript月份从0开始
                    const day = parseInt(dateValue.substr(2, 2));
                    const year = new Date().getFullYear(); // 使用当前年份
                    return new Date(Date.UTC(year, month, day));
                }
                
                // 处理 "M/D/YY" 格式
                const parts = dateValue.split('/');
                if (parts.length === 3) {
                    const month = parseInt(parts[0]) - 1; // JavaScript月份从0开始
                    const day = parseInt(parts[1]);
                    let year = parseInt(parts[2]);
                    
                    // 处理两位数年份
                    if (year < 100) {
                        year += year < 50 ? 2000 : 1900;
                    }
                    
                    return new Date(Date.UTC(year, month, day));
                }
                
                // 如果上面的方法失败，尝试使用 Date 构造函数
                const date = new Date(dateValue);
                if (!isNaN(date.getTime())) {
                    return new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                }
            }
            
            return null;
        }
    </script>
</body>
</html>
