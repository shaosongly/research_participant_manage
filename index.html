<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>受试者信息提交</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 66px;
        }
        .container {
            max-width: 600px;
            margin-top: 30px;
        }
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            padding: 0.2rem 0;
            /* 减小上下内边距 */
            min-height: 40px;
            /* 设置最小高度 */
        }

        .navbar-brand {
            padding: 0;
            /* 去掉内边距 */
            font-size: 1rem;
            /* 保持品牌文字大小 */
        }

        .navbar-nav {
            flex-direction: row;
            /* 确保导航项在一行显示 */
            align-items: center;
            /* 垂直居中 */
        }

        .nav-item {
            display: flex;
            /* 确保每个导航项的内容居中 */
            align-items: center;
            /* 垂直居中 */
        }

        .nav-link {
            padding: 0.2rem 0.5rem;
            /* 减小导航链接的上下内边距 */
            font-size: 0.9rem;
            /* 保持导航链接文字大小 */
        }
    </style>
</head>
<body>
    <!-- 添加导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="landing.html">受试者管理系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto"> <!-- 添加 ms-auto 类 -->
                    <li class="nav-item">
                        <a class="nav-link" href="landing.html">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="project_manage.html">项目管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html">添加受试者</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="view.html">查看受试者</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="schedule.html">访视安排</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="visit_plan.html">访视计划</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="mb-4 text-center">受试者信息提交</h1>
        <div class="card">
            <div class="card-body">
                <form id="subjectForm">
                    <!-- 项目和中心选择 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="projectSelect" class="form-label">选择项目:</label>
                                <select class="form-select" id="projectSelect" required>
                                    <option value="">请选择项目</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="centerSelect" class="form-label">选择中心:</label>
                                <select class="form-select" id="centerSelect" required>
                                    <option value="">请先选择项目</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="subjectName" class="form-label">受试者编号:</label>
                        <input type="text" class="form-control" id="subjectName" required>
                    </div>
                    <div class="mb-3">
                        <label for="firstDate" class="form-label">首次受试日期:</label>
                        <input type="text" class="form-control" id="firstDate" name="firstDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="totalVisits" class="form-label">总访视次数(包含首次访视):</label>
                        <input type="number" class="form-control" id="totalVisits" name="totalVisits" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">访视设置:</label>
                        <div class="card">
                            <div class="card-body">
                                <!-- 访视类型选择 -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="frequencyType" id="fixedFrequency" value="fixed" checked>
                                        <label class="form-check-label" for="fixedFrequency">
                                            固定间隔
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="frequencyType" id="variableFrequency" value="variable">
                                        <label class="form-check-label" for="variableFrequency">
                                            变化间隔
                                        </label>
                                    </div>
                                </div>

                                <!-- 固定间隔输入区域 -->
                                <div id="fixedFrequencyInput">
                                    <div class="mb-3">
                                        <label for="fixedDays" class="form-label">固定访视间隔(天):</label>
                                        <input type="number" class="form-control" id="fixedDays" min="1" value="1">
                                    </div>
                                    <div class="mb-3">
                                        <label for="fixedWindow" class="form-label">固定访视窗口(±天数):</label>
                                        <input type="number" class="form-control" id="fixedWindow" min="0" value="0">
                                        <div class="form-text">0表示无访视窗口</div>
                                    </div>
                                </div>

                                <!-- 变化间隔表格 -->
                                <div id="variableFrequencyInput" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="visitTable">
                                            <thead>
                                                <tr>
                                                    <th>访视次数</th>
                                                    <th>间隔天数</th>
                                                    <th>访视窗口(±天数)</th>
                                                </tr>
                                            </thead>
                                            <tbody id="visitTableBody">
                                                <!-- 动态生成的行 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">提交</button>
                </form>
            </div>
        </div>
        <h2 class="mt-5 mb-4 text-center">批量导入受试者信息</h2>
        <div class="card">
            <div class="card-body">
                <form id="batchImportForm">
                    <div class="mb-3">
                        <label for="excelFile" class="form-label">选择Excel文件：</label>
                        <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls" required>
                    </div>
                    <div id="columnMapping" class="mb-3">
                        <!-- 字段映射将在这里动态生成 -->
                    </div>
                    <button type="submit" class="btn btn-primary w-100">批量导入</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 引入 Bootstrap JS 和 Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
    <!-- 引入 Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- 引入 Flatpickr 中文语言包 -->
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh.js"></script>
    <!-- 引入自定义 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script>
        // 初始化 Flatpickr
        flatpickr("#firstDate", {
            dateFormat: "Y-m-d",
            locale: "zh",
            allowInput: true,
            altInput: true,
            altFormat: "Y年m月d日",
            disableMobile: true
        });

        let db;
        const dbName = "ResearchDB";

        // 初始化数据库连接
        const request = indexedDB.open(dbName);

        request.onerror = function(event) {
            console.error("数据库错误:", event.target.error);
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            loadProjectsAndCenters();
            
            // 如果URL中包含项目和中心参数，自动选择对应选项
            const urlParams = new URLSearchParams(window.location.search);
            const projectFromUrl = urlParams.get('project');
            const centerFromUrl = urlParams.get('center');
            
            if (projectFromUrl) {
                setTimeout(() => {
                    document.getElementById('projectSelect').value = projectFromUrl;
                    loadCentersForProject(projectFromUrl);
                    if (centerFromUrl) {
                        setTimeout(() => {
                            document.getElementById('centerSelect').value = centerFromUrl;
                        }, 100);
                    }
                }, 100);
            }
        };

        // 加载项目和中心数据
        async function loadProjectsAndCenters() {
            try {
                const transaction = db.transaction(['projects'], 'readonly');
                const projectStore = transaction.objectStore('projects');
                
                const projects = await new Promise((resolve) => {
                    projectStore.getAll().onsuccess = (event) => resolve(event.target.result);
                });
                
                const projectSelect = document.getElementById('projectSelect');
                projectSelect.innerHTML = '<option value="">请选择项目</option>' +
                    projects.map(project => 
                        `<option value="${project.projectName}">${project.projectName}</option>`
                    ).join('');
            } catch (error) {
                console.error('Error loading projects:', error);
                alert('加载项目列表失败');
            }
        }

        // 根据选择的项目加载对应的中心
        async function loadCentersForProject(projectName) {
            try {
                const transaction = db.transaction(['centers'], 'readonly');
                const centerStore = transaction.objectStore('centers');
                const centerIndex = centerStore.index('projectName');
                
                const centers = await new Promise((resolve) => {
                    centerIndex.getAll(projectName).onsuccess = (event) => resolve(event.target.result);
                });
                
                const centerSelect = document.getElementById('centerSelect');
                centerSelect.innerHTML = '<option value="">请选择中心</option>' +
                    centers.map(center => 
                        `<option value="${center.centerName}">${center.centerName}</option>`
                    ).join('');
            } catch (error) {
                console.error('Error loading centers:', error);
                alert('加载中心列表失败');
            }
        }

        // 监听项目选择变化
        document.getElementById('projectSelect').addEventListener('change', function() {
            const projectName = this.value;
            if (projectName) {
                loadCentersForProject(projectName);
            } else {
                document.getElementById('centerSelect').innerHTML = '<option value="">请先选择项目</option>';
            }
        });

        // 修改表单提交处理
        document.getElementById('subjectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const projectName = document.getElementById('projectSelect').value;
            const centerName = document.getElementById('centerSelect').value;
            const subjectName = document.getElementById('subjectName').value;
            const firstDate = document.getElementById('firstDate').value;
            const totalVisits = document.getElementById('totalVisits').value;
            const isFixedFrequency = document.getElementById('fixedFrequency').checked;
            
            if (!projectName || !centerName) {
                alert('请选择项目和中心');
                return;
            }

            // 获取访视间隔和窗口
            let frequency, visitWindow;
            if (isFixedFrequency) {
                // 固定间隔模式
                frequency = document.getElementById('fixedDays').value;
                visitWindow = document.getElementById('fixedWindow').value || '0';
            } else {
                // 变化间隔模式
                frequency = Array.from(document.querySelectorAll('.visit-frequency'))
                    .map(input => input.value)
                    .join(',');
                visitWindow = Array.from(document.querySelectorAll('.visit-window'))
                    .map(input => input.value || '0')
                    .join(',');
            }
            
            const subjectData = {
                project: projectName,
                center: centerName,
                name: subjectName,
                firstDate: firstDate,
                totalVisits: parseInt(totalVisits),
                frequency: frequency,
                visitWindow: visitWindow
            };
            
            try {
                const transaction = db.transaction(['subjects'], 'readwrite');
                const objectStore = transaction.objectStore('subjects');
                await new Promise((resolve, reject) => {
                    const request = objectStore.add(subjectData);
                    request.onsuccess = resolve;
                    request.onerror = reject;
                });
                
                console.log('数据保存成功:', subjectData);
                window.location.href = 'view.html';
            } catch (error) {
                console.error('保存数据时出错:', error);
                alert('保存失败，请重试');
            }
        });

        // 处理Excel文件上传
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const headers = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0];

                // 生成字段映射选择
                const mappingHtml = headers.map((header, index) => `
                    <div class="mb-2">
                        <label class="form-label">Excel列 "${header}" 对应：</label>
                        <select class="form-select" data-excel-column="${index}">
                            <option value="">请选择</option>
                            <option value="project">项目（可选）</option>
                            <option value="center">中心（可选）</option>
                            <option value="name">受试者名称</option>
                            <option value="firstDate">首次受试日期</option>
                            <option value="frequency">访视间隔</option>
                            <option value="totalVisits">总访视次数</option>
                            <option value="visitWindow">访视窗口（可选）</option>
                        </select>
                    </div>
                `).join('');

                document.getElementById('columnMapping').innerHTML = mappingHtml;
            };

            reader.readAsArrayBuffer(file);
        });

        // 处理批量导入
        document.getElementById('batchImportForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const selectedProject = document.getElementById('projectSelect').value;
            const selectedCenter = document.getElementById('centerSelect').value;

            if (!selectedProject || !selectedCenter) {
                alert('请先在页面上方选择项目和中心');
                return;
            }

            const file = document.getElementById('excelFile').files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, raw: false});

                // 获取用户定义的字段映射
                const mapping = {};
                document.querySelectorAll('#columnMapping select').forEach(select => {
                    const field = select.value;
                    const columnIndex = parseInt(select.dataset.excelColumn);
                    if (field) {  // 只保存有效的映射
                        mapping[field] = columnIndex;
                    }
                });

                // 检查必要字段是否都已映射（项目和中心现在是可选的）
                const requiredFields = ['name', 'firstDate', 'totalVisits'];
                const missingFields = requiredFields.filter(field => mapping[field] === undefined);
                if (missingFields.length > 0) {
                    alert(`请映射所有必要字段: ${missingFields.join(', ')}`);
                    return;
                }

                // 转换数据
                const subjectsData = jsonData.slice(1).map(row => {
                    // 创建基础对象，使用选择框中的项目和中心作为默认值
                    const subject = {
                        project: selectedProject,
                        center: selectedCenter,
                        name: null,
                        firstDate: null,
                        totalVisits: null,
                        frequency: null,
                        visitWindow: '0'  // 默认访视窗口为0
                    };

                    // 处理映射的字段
                    Object.keys(mapping).forEach(field => {
                        const columnIndex = mapping[field];
                        if (columnIndex !== undefined && columnIndex < row.length) {
                            if (field === 'firstDate') {
                                const dateValue = row[columnIndex];
                                const parsedDate = parseExcelDate(dateValue);
                                subject[field] = parsedDate ? parsedDate.toISOString().split('T')[0] : null;
                            } else if (field === 'frequency') {
                                // 直接使用Excel中的访视间隔值
                                subject.frequency = row[columnIndex]?.toString().trim() || null;
                            } else if (field === 'visitWindow') {
                                // 访视窗口是可选的，如果有值则使用，否则保持默认值0
                                const windowValue = row[columnIndex]?.toString().trim();
                                if (windowValue && windowValue !== '') {
                                    subject.visitWindow = windowValue;
                                }
                            } else if (field === 'totalVisits') {
                                const visits = parseInt(row[columnIndex]);
                                subject[field] = !isNaN(visits) ? visits : null;
                            } else if (field === 'name') {
                                subject[field] = row[columnIndex]?.toString().trim() || null;
                            } else if (field === 'project' || field === 'center') {
                                // 如果Excel中有项目或中心列，则覆盖默认值
                                const value = row[columnIndex]?.toString().trim();
                                if (value) {
                                    subject[field] = value;
                                }
                            }
                        }
                    });

                    return subject;
                });

                // 添加调试日志
                console.log('转换后的数据:', subjectsData);

                // 修改验证逻辑
                const invalidSubjects = subjectsData.filter(subject => {
                    const isInvalid = !subject.name || 
                                      !subject.firstDate || 
                                      !subject.totalVisits || 
                                      subject.totalVisits <= 0 || 
                                      !subject.frequency;
                    if (isInvalid) {
                        console.log('无效数据:', subject);
                        console.log('原因:', {
                            noName: !subject.name,
                            noDate: !subject.firstDate,
                            noVisits: !subject.totalVisits,
                            invalidVisits: subject.totalVisits <= 0,
                            noFrequency: !subject.frequency
                        });
                    }
                    return isInvalid;
                });

                if (invalidSubjects.length > 0) {
                    alert(`发现 ${invalidSubjects.length} 条无效数据，请检查Excel文件`);
                    console.error('Invalid subjects:', invalidSubjects);
                    return;
                }

                // 添加保存数据的逻辑
                try {
                    const transaction = db.transaction(['subjects'], 'readwrite');
                    const objectStore = transaction.objectStore('subjects');
                    
                    // 使用 Promise.all 批量保存数据
                    await Promise.all(subjectsData.map(subject => 
                        new Promise((resolve, reject) => {
                            const request = objectStore.add(subject);
                            request.onsuccess = resolve;
                            request.onerror = (event) => {
                                console.error('保存失败的数据:', subject);
                                reject(event.target.error);
                            };
                        })
                    ));
                    
                    console.log('批量导入成功，共导入', subjectsData.length, '条数据');
                    window.location.href = 'view.html';
                } catch (error) {
                    console.error('批量导入失败:', error);
                    alert('导入失败，请检查数据是否重复或格式是否正确');
                }
            };

            reader.readAsArrayBuffer(file);
        });

        // 修改后的日期解析函数
        function parseExcelDate(dateValue) {
            console.log("Original date value:", dateValue);
            
            if (dateValue instanceof Date) {
                return new Date(Date.UTC(dateValue.getFullYear(), dateValue.getMonth(), dateValue.getDate()));
            }
            
            if (typeof dateValue === 'number') {
                // Excel的日期数字是从1900年1月1日开始的天数
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                return new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            }
            
            if (typeof dateValue === 'string') {
                // 处理 "MMDD" 格式
                if (/^\d{4}$/.test(dateValue)) {
                    const month = parseInt(dateValue.substr(0, 2)) - 1; // JavaScript月份从0开始
                    const day = parseInt(dateValue.substr(2, 2));
                    const year = new Date().getFullYear(); // 使用当前年份
                    return new Date(Date.UTC(year, month, day));
                }
                
                // 处理 "M/D/YY" 格式
                const parts = dateValue.split('/');
                if (parts.length === 3) {
                    const month = parseInt(parts[0]) - 1; // JavaScript月份从0开始
                    const day = parseInt(parts[1]);
                    let year = parseInt(parts[2]);
                    
                    // 处理两位数年份
                    if (year < 100) {
                        year += year < 50 ? 2000 : 1900;
                    }
                    
                    return new Date(Date.UTC(year, month, day));
                }
                
                // 如果上面的方法失败，尝试使用 Date 构造函数
                const date = new Date(dateValue);
                if (!isNaN(date.getTime())) {
                    return new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                }
            }
            
            return null;
        }

        // 监听访视次数变化
        document.getElementById('totalVisits').addEventListener('change', function() {
            updateVisitTable();
        });

        // 监听间隔类型切换
        document.querySelectorAll('input[name="frequencyType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isFixed = this.value === 'fixed';
                document.getElementById('fixedFrequencyInput').style.display = isFixed ? 'block' : 'none';
                document.getElementById('variableFrequencyInput').style.display = isFixed ? 'none' : 'block';
                if (!isFixed) {
                    updateVisitTable();
                }
            });
        });

        function updateVisitTable() {
            const totalVisits = parseInt(document.getElementById('totalVisits').value) || 0;
            const tbody = document.getElementById('visitTableBody');
            tbody.innerHTML = '';

            // 从第二次访视开始（跳过首次访视）
            for (let i = 2; i <= totalVisits; i++) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>第 ${i} 次访视</td>
                    <td>
                        <input type="number" class="form-control form-control-sm visit-frequency" 
                               min="1" value="1" data-visit="${i}">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm visit-window" 
                               min="0" value="0" data-visit="${i}">
                    </td>
                `;
            }
        }
    </script>
</body>
</html>
